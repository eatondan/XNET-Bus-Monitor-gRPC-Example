//---------------------------------------------------------------------
// Copyright 2020 National Instruments
//
// Licensed under the MIT License;
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://mit-license.org/
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//---------------------------------------------------------------------

//Set syntax

syntax = "proto3";

//Import additional protos

import "google/protobuf/timestamp.proto";

//Set your directives for code geneation, langauge specific behaviors, meta data, etc.

option java_multiple_files = true;
option java_package = "labview.NI_XNET_CAN_Bus_Monitor_API";
option java_outer_classname = "NI_XNET_CAN_Bus_Monitor_API";
option objc_class_prefix = "LVCA";

//Name the package

package ni_xnet_can_bm_api; 

//---------------------------------------------------------------------

service NI_XNET_CAN_Bus_Monitor_API {
  
  rpc PassThru (PassThruRequest) returns (PassThruReply) {}

  //Pushes a RAW CAN frame directly to the bus.

  rpc GetStreamingFilter (GetStreamingFilterRequest) returns (GetStreamingFilterReply) {}

  //Get the current engine filter settings.
  
  rpc SetStreamingFilter (SetStreamingFilterRequest) returns (SetStreamingFilterReply) {}

  //Set the current engine filter settings.

  rpc ResetStreamingFilter (ResetStreamingFilterRequest) returns (ResetStreamingFilterReply) {}

  //Reset the current engine filter settings to default values.

  rpc InitializeSettings (InitializeSettingsRequest) returns (InitializeSettingsReply) {}

  /*Sets the XNET settings for the port:
	-CAN Port
	-Baud rates
	-Termination
  */

  rpc StopProcess (StopProcessRequest) returns (StopProcessReply) {}

  rpc StreamBus (StreamBusRequest) returns (stream StreamBusReply) {}

  /*Returns entire bus stream*/

  }

//Enums
  enum FrameFilter{
    CAN_Data = 0;
    CAN_Remote = 1;
    CAN_Bus_Error = 2;
    CAN_2_Data = 3;
    CAN_FD_Data = 4; 
	CAN_FD_BRS_Data = 5;
    J1939_Data = 6;
	Delay = 7;
    Log_Trigger = 8;
    Start_Trigger = 9;
	All = 10;
  }

  enum DirectionFilter{
    TX_RX = 0;
    RX = 1; 
    TX = 2; 
  }

  enum CanMode{
	CAN_2 = 0;
	CAN_FD = 1;
	CAN_FD_BRS = 2;
  }
  
  enum CommState{
	Error_Active = 0;
	Error_Passive = 1;
	Bus_Off = 2;
	Init = 3;
  }
  
  enum LastCommError{
	None = 0;
	Stuff = 1;
	Form = 2;
	ACK = 3;
	Bit1 = 4;
	Bit0 = 5;
	CRC = 6;
  }
  
  enum FdIsoMode{
	ISO = 0;
	Non_ISO = 1;
	ISO_Legacy = 2;
  }
  
  enum Termination {
	Term_Off = 0;
	Term_On = 1;
  }

//Message Typedefs
  message Frame{
    double timestamp = 1;
	bytes payload = 2;
	uint32 identifier = 3; //arb id
    uint32 frame_type= 4; 
    bool extended = 5; 
    bool echo = 6;  
  }

  message ErrorInfo{
    bool status = 1;
	int32 code = 2; //Error code; 0 is no error
    string source = 3; //Error message
  }
  
  message FilterInfo{
    repeated uint32 filter_ids = 1;
    DirectionFilter direction_filter = 2;
    FrameFilter frame_filter = 3;
  }
  
  message ConnectSettings{
	string port = 1;
	CanMode can_mode = 2;
	Termination termination = 3;
	uint64 baud_rate = 4;
	uint64 fd_baud_rate = 5;
	FdIsoMode fd_iso_mode = 6;
  }

  message CanCommState{
	int32 fault_code = 1;
	bool fault = 2;
	CommState comm_state = 3;
	LastCommError last_comm_error =  4;
	uint32 receive_error_counter = 5;
	uint32 transmit_error_counter = 6;
	bool transceiver_error = 7;
	bool sleep = 8;
  }

// PassThru
  message PassThruRequest{
    Frame frame = 1; 
  }

  message PassThruReply{
    ErrorInfo error = 1;
  }

 // Get Streaming Filter
  message GetStreamingFilterRequest{}

  message GetStreamingFilterReply{
    FilterInfo filter_info = 1;
	ErrorInfo error = 2;
  }

 // Set Streaming Filter
  message SetStreamingFilterRequest{
    FilterInfo filter_info = 1;
  }

  message SetStreamingFilterReply{
    ErrorInfo error = 1;
  }

 // Reset Streaming Filter
  message ResetStreamingFilterRequest{}

  message ResetStreamingFilterReply{
    FilterInfo filter_info = 1;
	ErrorInfo error = 2;
  }

 // Reset Initialize Settings
  message InitializeSettingsRequest{
	string name = 1;
	ConnectSettings connect_settings = 2;
	repeated uint32 default_filter_ids = 3;
  }
  
  message InitializeSettingsReply{
	ErrorInfo error = 1;
  }

// Stop Process
  message StopProcessRequest{}
  
  message StopProcessReply{
	bool stopped = 1;
	ErrorInfo error = 2;
  }

// Bus Stream
  message StreamBusRequest{}

  message StreamBusReply{
	CanCommState can_comm_state = 1;
	repeated Frame frame = 2;
	ErrorInfo error = 3;
  }